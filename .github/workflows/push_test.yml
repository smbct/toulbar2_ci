name: CI
on:
  push: # check Linux build and test on push
    branches:
      - 'ci-cd'
  # workflow_dispatch:

jobs:

  push_test:
    runs-on: ubuntu-latest
    steps:
      
      - uses: actions/cache@v4
        id: cache
        with:
          path: ${{runner.workspace}}/toulbar2
          key: toulbar2_ci

      - uses: actions/checkout@v4
        with:
          clean: false

      - name: Build on push
        uses: ./.github/actions/linux_build
        with:
          pytb2: 'ON'
          mpi: 'OFF'
          run_tests: true

      # delete previous cache
      - name: Cleanup cache
        env:
          SUPER_SECRET: ${{ secrets.SuperSecret }}
          GH_TOKEN: ${{ secrets.GH_CLI_TOKEN }}
        run: gh cache delete toulbar2_ci